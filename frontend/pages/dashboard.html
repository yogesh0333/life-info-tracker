<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Life Info Tracker</title>
    
    <!-- Config & Auth -->
    <script src="../config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="../js/userData.js"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FullCalendar -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        body {
            background: var(--light);
            font-family: 'Inter', sans-serif;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            width: 260px;
            padding: 2rem 0;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.9);
            padding: 0.8rem 2rem;
            margin: 0.2rem 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        #calendar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .goal-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .goal-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .progress-ring {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 75%, #e5e7eb 75% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .progress-ring::before {
            content: '';
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }
        
        .progress-text {
            position: relative;
            z-index: 1;
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="px-4 mb-4">
                <h4 class="fw-bold"><i class="fas fa-rocket me-2"></i>Life Tracker</h4>
                <p class="mb-0 opacity-75 small" id="userName">Loading...</p>
                <p class="mb-0 opacity-50 small" id="userLifePath">Life Path: -</p>
            </div>
            
            <nav class="nav flex-column">
                <a class="nav-link active" href="dashboard.html">
                    <i class="fas fa-chart-line me-2"></i> Dashboard
                </a>
                <a class="nav-link" href="daily-tracker.html">
                    <i class="fas fa-calendar-alt me-2"></i> Calendar
                </a>
                <a class="nav-link" href="daily-tracker.html">
                    <i class="fas fa-book me-2"></i> Daily Log
                </a>
                <a class="nav-link" href="daily-tracker.html">
                    <i class="fas fa-bullseye me-2"></i> Goals
                </a>
                <a class="nav-link" href="ai-assistant.html">
                    <i class="fas fa-robot me-2"></i> AI Assistant
                </a>
                <a class="nav-link" href="dashboard.html">
                    <i class="fas fa-chart-bar me-2"></i> Analytics
                </a>
                <a class="nav-link" href="ai-assistant.html">
                    <i class="fas fa-om me-2"></i> Muhurat
                </a>
                <a class="nav-link" href="../home.html">
                    <i class="fas fa-home me-2"></i> Home
                </a>
                <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">
                <a class="nav-link" href="#" onclick="logout(); return false;">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content flex-fill">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 fw-bold mb-1">Dashboard</h1>
                    <p class="text-muted mb-0" id="currentDate"></p>
                </div>
                <div>
                    <button class="btn btn-primary me-2" onclick="logToday()">
                        <i class="fas fa-plus me-2"></i>Log Today
                    </button>
                    <button class="btn btn-outline-primary" onclick="askAI()">
                        <i class="fas fa-robot me-2"></i>Ask AI
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div>
                                <h3 class="h2 fw-bold mb-0" id="streak">0</h3>
                                <p class="text-muted mb-0 small">Day Streak</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div>
                                <h3 class="h2 fw-bold mb-0" id="todayScore">0</h3>
                                <p class="text-muted mb-0 small">Today's Score</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <div>
                                <h3 class="h2 fw-bold mb-0" id="activeGoals">0</h3>
                                <p class="text-muted mb-0 small">Active Goals</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-danger bg-opacity-10 text-danger me-3">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <h3 class="h2 fw-bold mb-0" id="todayEvents">0</h3>
                                <p class="text-muted mb-0 small">Today's Events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Grid -->
            <div class="row g-4">
                <!-- Calendar & Progress -->
                <div class="col-lg-8">
                    <div id="calendar" class="mb-4"></div>
                    
                    <!-- Weekly Progress Chart -->
                    <div class="stat-card">
                        <h5 class="fw-bold mb-4"><i class="fas fa-chart-line me-2"></i>Weekly Progress</h5>
                        <canvas id="weeklyChart" height="80"></canvas>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Today's Log Quick Entry -->
                    <div class="stat-card mb-4">
                        <h5 class="fw-bold mb-3"><i class="fas fa-bolt me-2"></i>Quick Log</h5>
                        <form id="quickLogForm">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Mood</label>
                                <select class="form-select form-select-sm" name="mood">
                                    <option>excellent</option>
                                    <option selected>good</option>
                                    <option>okay</option>
                                    <option>bad</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Energy (1-10)</label>
                                <input type="range" class="form-range" name="energy" min="1" max="10" value="5" oninput="document.getElementById('energyValue').innerText=this.value">
                                <span class="badge bg-primary" id="energyValue">5</span>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100">Save Quick Log</button>
                        </form>
                    </div>
                    
                    <!-- Active Goals -->
                    <div class="stat-card mb-4">
                        <h5 class="fw-bold mb-3"><i class="fas fa-bullseye me-2"></i>Active Goals</h5>
                        <div id="goalsList"></div>
                    </div>
                    
                    <!-- Today's Events -->
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3"><i class="fas fa-calendar-day me-2"></i>Today's Events</h5>
                        <div id="todayEventsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get token from localStorage
        const token = localStorage.getItem('token');
        
        // Check authentication
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // Load user data
        let userData = null;
        
        // Set current date
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-IN', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Initialize Calendar
        let calendar;
        document.addEventListener('DOMContentLoaded', async function() {
            // Load user data first
            try {
                userData = await UserDataService.init();
                // Update sidebar with user info
                document.getElementById('userName').textContent = UserDataService.getName();
                document.getElementById('userLifePath').textContent = `Life Path: ${UserDataService.getLifePath()} (${UserDataService.getPlanetaryRuler().planet})`;
            } catch (error) {
                console.error('Error loading user data:', error);
                // Redirect to login if auth fails
                if (error.message.includes('token') || error.message.includes('401')) {
                    window.location.href = 'login.html';
                }
            }
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const response = await fetch(`${API_URL}/daily-logs?start=${info.startStr}&end=${info.endStr}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const events = (data.logs || []).map(log => ({
                                title: log.mood || 'Logged',
                                start: log.date,
                                color: log.mood === 'excellent' ? '#10b981' : log.mood === 'good' ? '#6366f1' : '#f59e0b'
                            }));
                            successCallback(events);
                        } else {
                            successCallback([]);
                        }
                    } catch (error) {
                        console.error('Error loading events:', error);
                        successCallback([]);
                    }
                },
                eventClick: function(info) {
                    alert('Event: ' + info.event.title);
                }
            });
            calendar.render();
            
            // Load dashboard data
            loadDashboard();
            loadWeeklyChart();
        });
        
        // Load Dashboard Data
        async function loadDashboard() {
            try {
                // Try to fetch dashboard overview, fallback to basic stats
                try {
                    const response = await fetch(`${API_URL}/dashboard/overview`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            const { overview } = data;
                            document.getElementById('streak').innerText = overview.streak || 0;
                            document.getElementById('todayScore').innerText = overview.todayScore || 0;
                            document.getElementById('activeGoals').innerText = overview.activeGoals || 0;
                            document.getElementById('todayEvents').innerText = overview.todayEvents || 0;
                            loadGoals(overview.recentActivity?.goals || []);
                            loadTodayEvents(overview.recentActivity?.events || []);
                            return;
                        }
                    }
                } catch (e) {
                    console.log('Dashboard overview endpoint not available, using fallback');
                }
                
                // Fallback: Load from goals and daily-logs endpoints
                const [goalsRes, logsRes] = await Promise.all([
                    fetch(`${API_URL}/goals`, { headers: { 'Authorization': `Bearer ${token}` } }).catch(() => null),
                    fetch(`${API_URL}/daily-logs?limit=7`, { headers: { 'Authorization': `Bearer ${token}` } }).catch(() => null)
                ]);
                
                let activeGoals = 0;
                if (goalsRes && goalsRes.ok) {
                    const goalsData = await goalsRes.json();
                    activeGoals = (goalsData.goals || []).filter(g => !g.completed).length;
                }
                
                let streak = 0;
                if (logsRes && logsRes.ok) {
                    const logsData = await logsRes.json();
                    const logs = logsData.logs || [];
                    // Calculate streak
                    const today = new Date().toISOString().split('T')[0];
                    let currentDate = new Date(today);
                    for (let i = 0; i < 30; i++) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        if (logs.some(log => log.date === dateStr)) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                }
                
                document.getElementById('streak').innerText = streak;
                document.getElementById('todayScore').innerText = '0';
                document.getElementById('activeGoals').innerText = activeGoals;
                document.getElementById('todayEvents').innerText = '0';
                
                // Load goals list
                if (goalsRes && goalsRes.ok) {
                    const goalsData = await goalsRes.json();
                    loadGoals((goalsData.goals || []).slice(0, 5));
                } else {
                    loadGoals([]);
                }
                loadTodayEvents([]);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Load Weekly Chart
        async function loadWeeklyChart() {
            try {
                const response = await fetch(`${API_URL}/daily-logs?limit=7`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const logs = data.logs || [];
                    
                    // Create last 7 days data
                    const last7Days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        const log = logs.find(l => l.date === dateStr);
                        last7Days.push({
                            date: dateStr,
                            score: log ? (log.energy || 5) * 10 : 0
                        });
                    }
                    
                    const ctx = document.getElementById('weeklyChart');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: last7Days.map(s => new Date(s.date).toLocaleDateString('en-IN', { weekday: 'short' })),
                            datasets: [{
                                label: 'Daily Score',
                                data: last7Days.map(s => s.score),
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 100 }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading weekly chart:', error);
            }
        }
        
        // Load Goals
        function loadGoals(goals) {
            const goalsList = document.getElementById('goalsList');
            if (goals.length === 0) {
                goalsList.innerHTML = '<p class="text-muted small">No active goals</p>';
                return;
            }
            
            goalsList.innerHTML = goals.map(goal => `
                <div class="goal-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${goal.title}</h6>
                            <small class="text-muted">${goal.category}</small>
                        </div>
                        <span class="badge bg-${goal.priority === 'critical' ? 'danger' : 'primary'}">${goal.priority}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Load Today's Events
        function loadTodayEvents(events) {
            const eventsList = document.getElementById('todayEventsList');
            const todayEvents = events.filter(e => {
                const eventDate = new Date(e.start || e.startDate);
                const today = new Date();
                return eventDate.toDateString() === today.toDateString();
            });
            
            if (todayEvents.length === 0) {
                eventsList.innerHTML = '<p class="text-muted small">No events today</p>';
                return;
            }
            
            eventsList.innerHTML = todayEvents.map(event => `
                <div class="mb-2 pb-2 border-bottom">
                    <h6 class="mb-0">${event.title}</h6>
                    <small class="text-muted">${event.type || 'Event'}</small>
                </div>
            `).join('');
        }
        
        // Quick Log Form
        document.getElementById('quickLogForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                mood: formData.get('mood'),
                energy: parseInt(formData.get('energy'))
            };
            
            try {
                const response = await fetch(`${API_URL}/daily-logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Quick log saved!');
                    loadDashboard();
                }
            } catch (error) {
                console.error('Error saving quick log:', error);
            }
        });
        
        function logToday() {
            window.location.href = 'daily-tracker.html';
        }
        
        function askAI() {
            window.location.href = 'ai-assistant.html';
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>

